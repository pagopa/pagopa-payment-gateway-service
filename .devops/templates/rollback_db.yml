parameters:
  - name: version
  - name: poolName
  - name: azureSubscription
  - name: KeyVaultName
  - name: schemaName

jobs:
  - job: job_rollback_prep
    displayName: Rollback Preparation
    pool:
      name: ${{ parameters.poolName }}
    steps:
      - checkout: none

      - script: echo Rolling back to version ${{ parameters.version }}
        displayName: Echo Rollback Version

      - script: echo Rolling back schema ${{ parameters.schemaName }}
        displayName: Echo Rollback Schema

      - script: |
          echo "##vso[task.setvariable variable=ROLLBACK_SCHEMA;isOutput=true]${{ parameters.schemaName }}"
        displayName: "Setting ROLLBACK_SCHEMA Variable"
        name: setRollbackSchema

      - script: echo ROLLBACK_SCHEMA '$(setRollbackSchema.ROLLBACK_SCHEMA)'
        displayName: Echo Rollback Schema

  - job: job_rollback_agid
    displayName: AGID_USER Rollback Execution
    pool:
      name: ${{ parameters.poolName }}
    condition: and(succeeded(), eq(dependencies.job_rollback_prep.outputs['setRollbackSchema.ROLLBACK_SCHEMA'], 'AGID_USER'))
    dependsOn: job_rollback_prep
    steps:
      - checkout: none

      # PGS (PM)
      - template: ./liquibase-rollback.yml
        parameters:
          url: $(sit-db-agid-url-simple)
          username: $(sit-db-agid-username)
          password: $(sit-db-agid-password)
          classpath: $(Pipeline.Workspace)/${{ parameters.version }}-liquibase-script/changelogs/payment-transaction-gateway
          liquibaseSchemaName: $(sit-db-agid-schema)
          defaultSchemaName: $(sit-db-agid-schema)
          schema: $(sit-db-agid-schema)
          liquibaseTablespaceName: $(sit-db-agid-tablespace)
          title: "Rollback DB PGS"
          databaseChangelogLockTableName: "DATABASECHANGELOGLOCK_PGS"
          databaseChangelogTableName: "DATABASECHANGELOG_PGS"
          version: ${{ parameters.version }}
          contexts: "tag,baseline,incremental"
          azureSubscription: ${{ parameters.azureSubscription }}
          KeyVaultName: ${{ parameters.KeyVaultName }}